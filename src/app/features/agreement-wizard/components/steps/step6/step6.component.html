<div class="p-4">
    @if (isLoading()) {
    <div class="flex justify-center align-items-center p-6">
        <p-progressSpinner></p-progressSpinner>
    </div>
    }

    <!-- Form Section -->
    @if (!isViewMode()) {
    <div class="col-12 mb-4">
        <h3 class="text-xl font-semibold mb-4">{{ 'wizard.step6.title' | translate }}</h3>

        <form [formGroup]="step6Form">
            <div formGroupName="quantityBillDto">
                <div class="grid">
                    <!-- Material field -->
                    <div class="col-12 md:col-6 lg:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-select 
                                    inputId="materialId" 
                                    formControlName="materialId"
                                    [options]="materials()" 
                                    optionLabel="name" 
                                    optionValue="id"
                                    [class]="isFieldInvalid('materialId') ? 'ng-dirty ng-invalid w-full md:w-56' : 'w-full md:w-56'">
                                </p-select>
                                <label for="materialId">{{ 'wizard.step6.material' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('materialId')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('materialId') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Amount field -->
                    <div class="col-12 md:col-6 lg:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-inputNumber 
                                    inputId="ammount" 
                                    formControlName="ammount" 
                                    [min]="0"
                                    [showButtons]="true"
                                    [ngClass]="{'ng-invalid': isFieldInvalid('ammount')}"
                                    inputStyleClass="w-full">
                                </p-inputNumber>
                                <label for="ammount">{{ 'wizard.step6.quantity' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('ammount')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('ammount') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Unit field -->
                    <div class="col-12 md:col-6 lg:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-select 
                                    inputId="unitId" 
                                    formControlName="unitId"
                                    [options]="units()" 
                                    optionLabel="name" 
                                    optionValue="id"
                                    [class]="isFieldInvalid('unitId') ? 'ng-dirty ng-invalid w-full md:w-56' : 'w-full md:w-56'">
                                </p-select>
                                <label for="unitId">{{ 'wizard.step6.unit' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('unitId')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('unitId') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Milestone field -->
                    <div class="col-12 md:col-6 lg:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-select 
                                    inputId="mileStoneId" 
                                    formControlName="mileStoneId"
                                    [options]="milestones()" 
                                    optionLabel="name" 
                                    optionValue="id"
                                    [class]="isFieldInvalid('mileStoneId') ? 'ng-dirty ng-invalid w-full md:w-56' : 'w-full md:w-56'">
                                </p-select>
                                <label for="mileStoneId">{{ 'wizard.step6.milestone' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('mileStoneId')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('mileStoneId') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Price field -->
                    <div class="col-12 md:col-6 lg:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-inputNumber 
                                    inputId="price" 
                                    formControlName="price" 
                                    [min]="0"
                                    [showButtons]="false"
                                    mode="currency"
                                    currency="USD"
                                    locale="en-US"
                                    [minFractionDigits]="2"
                                    [maxFractionDigits]="2"
                                    [ngClass]="{'ng-invalid': isFieldInvalid('price')}"
                                    inputStyleClass="w-full">
                                </p-inputNumber>
                                <label for="price">{{ 'wizard.step6.price' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('price')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('price') }}</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-2">
                    <p-button 
                        [label]="'common.cancel' | translate" 
                        severity="secondary" 
                        icon="pi pi-times"
                        (onClick)="clearForm()">
                    </p-button>
                    <p-button 
                        [label]="editingIndex() !== null ? ('common.update' | translate) : ('common.add' | translate)"
                        icon="pi pi-check" 
                        (onClick)="addEntry()"
                        [disabled]="step6Form.get('quantityBillDto')?.invalid">
                    </p-button>
                </div>
            </div>
        </form>
    </div>
    }

    <!-- Table Section -->
    <div class="col-12">
        <div class="card">
            <div class="card-header border-b border-gray-200 pb-3 mb-3">
                <h4 class="text-lg font-semibold">{{ 'wizard.step6.entriesList' | translate }}</h4>
            </div>

            <!-- PrimeNG Table -->
            <p-table 
                [value]="getActiveEntries()" 
                [paginator]="true" 
                [rows]="5" 
                [showCurrentPageReport]="true"
                currentPageReportTemplate="{{ 'wizard.step6.showingEntries' | translate }}"
                [rowsPerPageOptions]="[5, 10, 25, 50]"
                [tableStyle]="{ 'min-width': '50rem' }"
                styleClass="p-datatable-striped">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th>{{ 'wizard.step6.material' | translate }}</th>
                        <th>{{ 'wizard.step6.quantity' | translate }}</th>
                        <th>{{ 'wizard.step6.unit' | translate }}</th>
                        <th>{{ 'wizard.step6.milestone' | translate }}</th>
                        <th>{{ 'wizard.step6.price' | translate }}</th>
                        <th>{{ 'wizard.step6.total' | translate }}</th>
                        @if (!isViewMode()) {
                        <th class="text-center" style="width: 150px">{{ 'common.actions' | translate }}</th>
                        }
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-entry let-rowIndex="rowIndex">
                    <tr>
                        <td>{{ getMaterialName(entry.materialId) }}</td>
                        <td>{{ entry.ammount | number }}</td>
                        <td>{{ getUnitName(entry.unitId) }}</td>
                        <td>{{ getMilestoneName(entry.mileStoneId) }}</td>
                        <td>{{ entry.price | currency:'USD':'symbol':'1.2-2' }}</td>
                        <td class="font-semibold">{{ calculateTotal(entry) | currency:'USD':'symbol':'1.2-2' }}</td>
                        @if (!isViewMode()) {
                        <td class="text-center">
                            <button 
                                type="button"
                                class="p-button-rounded p-button-text p-button-info mr-2"
                                (click)="editEntry(rowIndex)"
                                pButton
                                icon="pi pi-pencil"
                                [pTooltip]="'common.edit' | translate">
                            </button>
                            <button 
                                type="button"
                                class="p-button-rounded p-button-text p-button-danger"
                                (click)="deleteEntry(rowIndex)"
                                pButton
                                icon="pi pi-trash"
                                [pTooltip]="'common.delete' | translate">
                            </button>
                        </td>
                        }
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center p-6">
                            <i class="pi pi-inbox text-4xl mb-3 block text-gray-400"></i>
                            <p class="text-gray-500">{{ 'wizard.step6.noData' | translate }}</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>
