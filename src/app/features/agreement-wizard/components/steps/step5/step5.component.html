<div class="p-4">
    @if (isLoading()) {
    <div class="flex justify-center align-items-center p-6">
        <p-progressSpinner></p-progressSpinner>
    </div>
    }

    <!-- Form Section -->
    <div class="col-12 mb-4">
        <h3 class="text-xl font-semibold mb-4">{{ 'wizard.step5.title' | translate }}</h3>

        <form [formGroup]="step5Form">
            <div formGroupName="supplierServiceDto">
                <div class="grid">
                    <!-- Material field -->
                    <div class="col-12 md:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-select 
                                    inputId="materialId" 
                                    formControlName="materialId"
                                    [options]="materials()" 
                                    optionLabel="name" 
                                    optionValue="id"
                                    placeholder="{{ 'wizard.step5.selectMaterial' | translate }}"
                                    [class]="isFieldInvalid('materialId') ? 'ng-dirty ng-invalid w-full md:w-56' : 'w-full md:w-56'">
                                </p-select>
                                <label for="materialId">{{ 'wizard.step5.material' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('materialId')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('materialId') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Supplier field -->
                    <div class="col-12 md:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <p-select 
                                    inputId="supplierId" 
                                    formControlName="supplierId"
                                    [options]="suppliers()" 
                                    optionLabel="name" 
                                    optionValue="id"
                                    placeholder="{{ 'wizard.step5.selectSupplier' | translate }}"
                                    [class]="isFieldInvalid('supplierId') ? 'ng-dirty ng-invalid w-full md:w-56' : 'w-full md:w-56'">
                                </p-select>
                                <label for="supplierId">{{ 'wizard.step5.supplier' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('supplierId')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('supplierId') }}</small>
                            }
                        </div>
                    </div>

                    <!-- Representative Name field -->
                    <div class="col-12 md:col-4 mb-3">
                        <div class="field">
                            <p-floatlabel variant="in">
                                <input 
                                    pInputText
                                    inputId="representativeName" 
                                    formControlName="representativeName"
                                    class="w-full"
                                    placeholder="{{ 'wizard.step5.enterRepresentativeName' | translate }}"
                                    [class.ng-invalid]="isFieldInvalid('representativeName')"
                                />
                                <label for="representativeName">{{ 'wizard.step5.representativeName' | translate }}</label>
                            </p-floatlabel>
                            @if (isFieldInvalid('representativeName')) {
                            <small class="text-red-500 block mt-1">{{ getFieldError('representativeName') }}</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-2">
                    <p-button 
                        [label]="'common.cancel' | translate" 
                        severity="secondary" 
                        icon="pi pi-times"
                        (onClick)="clearForm()">
                    </p-button>
                    <p-button 
                        [label]="editingIndex() !== null ? ('common.update' | translate) : ('common.add' | translate)"
                        icon="pi pi-check" 
                        (onClick)="addEntry()"
                        [disabled]="step5Form.get('supplierServiceDto')?.invalid">
                    </p-button>
                </div>
            </div>
        </form>
    </div>

    <!-- Table Section -->
    <div class="col-12">
        <div class="card">
            <div class="card-header border-b border-gray-200 pb-3 mb-3">
                <h4 class="text-lg font-semibold">{{ 'wizard.step5.entriesList' | translate }}</h4>
            </div>

            <!-- PrimeNG Table -->
            <p-table 
                [value]="getActiveEntries()" 
                [paginator]="true" 
                [rows]="5" 
                [showCurrentPageReport]="true"
                currentPageReportTemplate="{{ 'wizard.step5.showingEntries' | translate }}"
                [rowsPerPageOptions]="[5, 10, 25, 50]"
                [tableStyle]="{ 'min-width': '50rem' }"
                styleClass="p-datatable-striped">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th>{{ 'wizard.step5.material' | translate }}</th>
                        <th>{{ 'wizard.step5.supplier' | translate }}</th>
                        <th>{{ 'wizard.step5.representativeName' | translate }}</th>
                        <th class="text-center" style="width: 150px">{{ 'common.actions' | translate }}</th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-entry let-rowIndex="rowIndex">
                    <tr>
                        <td>{{ getMaterialName(entry.materialId) }}</td>
                        <td>{{ getSupplierName(entry.supplierId) }}</td>
                        <td>{{ entry.representativeName }}</td>
                        <td class="text-center">
                            <button 
                                type="button"
                                class="p-button-rounded p-button-text p-button-info mr-2"
                                (click)="editEntry(rowIndex)"
                                pButton
                                icon="pi pi-pencil"
                                [pTooltip]="'common.edit' | translate">
                            </button>
                            <button 
                                type="button"
                                class="p-button-rounded p-button-text p-button-danger"
                                (click)="deleteEntry(rowIndex)"
                                pButton
                                icon="pi pi-trash"
                                [pTooltip]="'common.delete' | translate">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="4" class="text-center p-6">
                            <i class="pi pi-inbox text-4xl mb-3 block text-gray-400"></i>
                            <p class="text-gray-500">{{ 'wizard.step5.noData' | translate }}</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>
